import streamlit as st
import pandas as pd
import numpy as np
import joblib
import os

# --- 1. Load Model and Data --- #
@st.cache_resource # Cache the model loading for performance
def load_model_and_data():
    model = joblib.load('random_forest_model.joblib')
    X_train_columns = joblib.load('X_train_columns.joblib')
    # Load the original DataFrame for reference values (means, max, unique categories)
    df = pd.read_csv('consumer_behavior_dataset.csv')
    return model, X_train_columns, df

model, X_train_columns, df = load_model_and_data()

# --- 2. Chatbot Prediction Function (Adapted for Streamlit) --- #
def chatbot_predict(message):
    msg = message.lower()

    # Handle immediate non-predictive responses (politeness) FIRST
    if any(word in msg for word in ["merci", "non, merci", "super", "bien", "ok", "cool"]):
        return "C'est un plaisir ! N'h√©sitez pas si vous avez d'autres questions ou si vous souhaitez finaliser votre achat."
    if any(word in msg for word in ["bonjour", "salut", "hello", "hi"]):
        return "Bonjour ! üòä Je suis votre assistant shopping personnel. Comment puis-je vous rendre service aujourd'hui ?"
    if any(word in msg for word in ["au revoir", "bye", "a bientot", "bonne journ√©e"]):
        return "Au revoir et √† bient√¥t ! N'oubliez pas nos offres exclusives. üòâ"

    # Handle Payment Methods Inquiry (informational, no prediction needed)
    if any(word in msg for word in ["modes de paiement", "moyens de paiement", "comment payer"]):
        return "Nous acceptons plusieurs modes de paiement s√©curis√©s, y compris les cartes de cr√©dit (Visa, MasterCard, Amex), PayPal, et le paiement √† la livraison (COD) pour certaines r√©gions. Lequel pr√©f√©rez-vous ?"

    # Initialize input_df for prediction with all X_train_columns, set to 0
    input_df = pd.DataFrame(0, index=[0], columns=X_train_columns)

    # Set numerical columns to their means as a baseline
    for col in ['price', 'discount_applied', 'pages_visited', 'time_spent', 'rating', 'sentiment_score', 'age']:
        if col in input_df.columns:
            input_df[col] = df[col].mean()

    # Set boolean flags to 0 as a baseline
    if 'add_to_cart' in input_df.columns: input_df['add_to_cart'] = 0
    if 'abandoned_cart' in input_df.columns: input_df['abandoned_cart'] = 0

    # Default intent to 'general' before specific detection
    current_intent = 'general'

    # --- Process user intents and adjust input_df for prediction --- #
    if any(word in msg for word in ["panier", "ajouter", "prends", "commande", "acheter", "valider"]):
        input_df['add_to_cart'] = 1
        input_df['pages_visited'] = 15 
        input_df['time_spent'] = 900 
        input_df['sentiment_score'] = 0.9
        current_intent = 'add_to_cart'
    elif any(word in msg for word in ["abandonn√©", "oubli√©", "laiss√©", "mon panier"]):
        input_df['abandoned_cart'] = 1
        input_df['add_to_cart'] = 1 
        input_df['pages_visited'] = 5 
        input_df['sentiment_score'] = -0.3
        current_intent = 'abandoned_cart'
    elif any(word in msg for word in ["cher", "prix", "budget", "co√ªte", "on√©reux"]):
        input_df['price'] = df['price'].max() * 0.8 
        input_df['sentiment_score'] = -0.5
        current_intent = 'price_concern'
    elif any(word in msg for word in ["r√©duction", "promo", "code", "remise", "soldes", "offre"]):
        input_df['discount_applied'] = df['discount_applied'].max() * 1.5 
        input_df['sentiment_score'] = 0.8
        current_intent = 'discount_inquiry'
    elif any(word in msg for word in ["avis", "qualit√©", "note", "fiable", "bon produit", "meilleur"]):
        input_df['rating'] = 5 
        input_df['sentiment_score'] = 0.7
        current_intent = 'quality_inquiry'
    elif any(word in msg for word in ["livraison", "o√π est ma commande", "exp√©di√©", "colis", "d√©lai"]):
        input_df['sentiment_score'] = 0.1 
        input_df['add_to_cart'] = 0 
        current_intent = 'shipping_inquiry'
    elif any(word in msg for word in ["paiement", "facture", "erreur de paiement", "probl√®me de paiement", "payer"]):
        input_df['sentiment_score'] = -0.6 
        input_df['abandoned_cart'] = 1 
        input_df['add_to_cart'] = 1 
        current_intent = 'payment_issue'
    elif any(word in msg for word in ["retour", "remboursement", "√©changer", "renvoyer"]):
        input_df['sentiment_score'] = -0.4 
        input_df['add_to_cart'] = 0 
        current_intent = 'product_return'
    elif any(word in msg for word in ["recommander", "similaire", "quel produit", "sugg√©rer", "pour moi"]):
        input_df['sentiment_score'] = 0.4 
        input_df['add_to_cart'] = 0 
        input_df['pages_visited'] = 10 
        current_intent = 'recommendation'
    elif any(word in msg for word in ["compte", "mot de passe", "profil", "identifiant", "connexion"]):
        input_df['sentiment_score'] = 0.0 
        current_intent = 'account_management'


    # Make Prediction using the loaded model
    prediction = model.predict(input_df)[0]

    # --- Generate Response based on prediction and current_intent ---
    if prediction == 1: # Model predicts PURCHASE
        if current_intent == 'add_to_cart':
            response = ("""Fantastique ! Vous √™tes √† un clic de votre nouvel achat ! ‚ú® Pour valider :
                        1Ô∏è‚É£ Cliquez sur **'Proc√©der au Paiement'**.
                        2Ô∏è‚É£ V√©rifiez vos informations de livraison.
                        3Ô∏è‚É£ Confirmez votre paiement s√©curis√©.
                        Besoin d'aide pour n'importe quelle √©tape ?""")
        elif current_intent == 'quality_inquiry':
            response = "Excellente nouvelle ! Le mod√®le pr√©dit que vous √™tes tr√®s proche d'une d√©cision d'achat. Nos retours clients sont excellents pour cet article. Pr√™t(e) √† l'ajouter √† votre collection ?"
        elif current_intent == 'discount_inquiry':
            response = "Effectivement, et avec les remises actuelles, c'est le moment id√©al pour finaliser ! Votre intention d'achat est tr√®s √©lev√©e. On concr√©tise ?"
        elif current_intent == 'recommendation':
            response = "Super ! D'apr√®s votre int√©r√™t, je suis s√ªr(e) que vous allez adorer. Je peux vous guider vers la page produit pour concr√©tiser cet achat si vous le souhaitez."
        else: # Default for Purchase or other intents where purchase is predicted
            response = ("""Quel enthousiasme ! Votre intention d'achat est palpable. ‚≠ê
                        Pour ne pas manquer ce produit tr√®s demand√©, je vous invite √† finaliser rapidement :
                        1Ô∏è‚É£ V√©rifiez votre panier.
                        2Ô∏è‚É£ Validez vos options de livraison.
                        3Ô∏è‚É£ Confirmez votre paiement.
                        Je suis l√† pour vous assister ! """)

    else: # Model predicts NO PURCHASE
        if current_intent == 'price_concern':
            response = ("Je comprends que le prix soit une consid√©ration. Pour all√©ger la d√©pense, nous vous proposons une **remise exclusive de 15%** sur ce produit ! Utilisez le code **SPECIAL15**. Qu'en pensez-vous ?")
        elif current_intent == 'abandoned_cart':
            response = ("Oh non ! Il semblerait que vous ayez laiss√© un tr√©sor dans votre panier. Pour vous aider √† le retrouver, je vous offre la **livraison gratuite** sur cet article avec le code **LIVFREE** ! C'est le moment de craquer, non ?")
        elif current_intent == 'discount_inquiry':
             response = ("Vous avez flair√© la bonne affaire ! J'ai un code exclusif pour vous : **PROMO20** pour 20% de r√©duction sur une s√©lection d'articles. √áa vous tente ?")
        elif current_intent == 'quality_inquiry':
            response = ("M√™me si le mod√®le ne pr√©dit pas un achat imm√©diat, je peux vous assurer de la qualit√© de nos produits. Pour vous rassurer, que diriez-vous d'une **garantie prolong√©e** ou d'une petite remise suppl√©mentaire avec le code **GARANTIEPLUS** pour 10% ?")
        elif current_intent == 'shipping_inquiry':
            response = ("Je comprends votre pr√©occupation concernant la livraison. Pour v√©rifier l'√©tat de votre commande ou les d√©lais estim√©s, vous pouvez consulter la section 'Suivi de Commande' sur votre compte ou me donner votre num√©ro de commande.")
        elif current_intent == 'payment_issue':
            response = ("Un probl√®me de paiement ? Ne vous inqui√©tez pas pas, cela arrive ! Je vous recommande de v√©rifier les d√©tails de votre carte, d'essayer un autre mode de paiement, ou de contacter notre support technique qui pourra vous aider imm√©diatement.")
        elif current_intent == 'product_return':
            response = ("Vous souhaitez effectuer un retour ou un √©change ? Notre politique de retour est simple : vous avez 30 jours pour changer d'avis. Pour initier le processus, rendez-vous dans la section 'Mes Commandes' de votre compte ou laissez-moi vous guider.")
        elif current_intent == 'recommendation':
            response = ("Je suis l√† pour vous aider √† trouver votre bonheur ! Pour des recommandations personnalis√©es, pourriez-vous me dire quels sont vos go√ªts ou ce que vous recherchez sp√©cifiquement ?")
        elif current_intent == 'account_management':
            response = ("Pour toute question relative √† votre compte (mot de passe, profil, informations personnelles), je vous invite √† visiter la section 'Mon Compte'. Vous y trouverez toutes les options n√©cessaires pour g√©rer vos informations.")
        else: # Default for No Purchase
            response = ("""Je per√ßois une certaine h√©sitation. üòä Pas de souci, je suis l√† pour vous guider ! Pour vous aider √† d√©couvrir nos p√©pites, j'ai le plaisir de vous offrir **-10%** sur votre premi√®re commande avec le code **BIENVENUE10**.\n\n                        Souhaitez-vous explorer nos cat√©gories phares ?""")

    return response

# --- 3. Streamlit App Layout --- #
st.set_page_config(page_title="üõí Assistant IA - Optimisation des Ventes", layout="centered")
st.title("üõí Assistant IA - Optimisation des Ventes")
st.write("Interface interactive utilisant un mod√®le Random Forest pour pr√©dire le comportement d'achat et assister les clients.")

# Initialize chat history
if "messages" not in st.session_state:
    st.session_state.messages = []
    # Initial chatbot greeting
    st.session_state.messages.append({"role": "assistant", "content": "Bonjour ! üòä Je suis votre assistant shopping personnel. Comment puis-je vous rendre service aujourd'hui ?"})

# Display chat messages from history on app rerun
for message in st.session_state.messages:
    with st.chat_message(message["role"]):
        st.markdown(message["content"])

# Accept user input
if prompt := st.chat_input("Comment puis-je vous aider ?"):
    # Add user message to chat history
    st.session_state.messages.append({"role": "user", "content": prompt})
    # Display user message in chat message container
    with st.chat_message("user"):
        st.markdown(prompt)

    # Get assistant response
    with st.chat_message("assistant"):
        response = chatbot_predict(prompt)
        st.markdown(response)
    # Add assistant response to chat history
    st.session_state.messages.append({"role": "assistant", "content": response})
